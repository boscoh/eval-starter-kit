<!doctype html>
<html>
  <head>
    <!-- avoid text rendering issues on various platforms -->
    <meta charset="utf-8" />

    <!-- prevent auto-zooming on mobile browsers -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Lodash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Pug template compiler -->
    <script src="https://pugjs.org/js/pug.js"></script>
    <script>
      window.pug = require("pug");

      function renderHtmlFromPug(str) {
        const lines = str.replace(/^\n/, "").split("\n");
        const minIndent = Math.min(
          ...lines
            .filter((l) => l.trim())
            .map((l) => l.match(/^\s*/)[0].length),
        );
        return pug.render(lines.map((l) => l.slice(minIndent)).join("\n"));
      }
    </script>

    <!-- Ky -->
    <script type="module">
      import ky from "https://unpkg.com/ky/distribution/index.js";

      window.ky = ky;
    </script>

    <!-- Custom styles -->
    <style>
      body {
        overflow-y: hidden;
      }
      .scrollable-column {
        height: calc(100vh - 182px);
        overflow-y: auto;
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
      }
    </style>
  </head>

  <body>
    <div id="app"></div>
  </body>

  <script>
    // language=pug
    const template = renderHtmlFromPug(`
    .container-fluid.h-100

      .toast-container
        .toast.align-items-center.text-white.border-0(
          v-for="(notification, index) in notifications"
          :key="notification.id"
          :data-toast-id="notification.id"
          :class="[notification.bgClass]"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
          data-bs-autohide="true"
          :data-bs-delay="notification.timeout"
        )
          .d-flex
            .toast-body {{ notification.message }}
            button.btn-close.btn-close-white.me-2.m-auto(
              type="button"
              data-bs-dismiss="toast"
              aria-label="Close"
            )

      .row.h-100
        .col-12

          // Title
          .d-flex.justify-content-between.align-items-center.mt-3
            .display-2.mx-3.my-3 Eval Starter Kit

          // Tab navigation
          ul.nav.nav-tabs.mt-3
            li.nav-item
              a.nav-link.active(data-bs-toggle="tab" href="#evals-tab")
                | Evals
            li.nav-item
              a.nav-link(data-bs-toggle="tab" href="#queries-tab")
                | Queries
            li.nav-item
              a.nav-link(data-bs-toggle="tab" href="#system-prompts-tab")
                | Prompts

          // Tab content
          .tab-content.h-100

            /// Eval tab
            #evals-tab.tab-pane.fade.show.active.h-100
              .d-flex.flex-row

                //// Eval tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 250px;")
                  .px-3.pt-4

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#createEvalModal"
                      @click="newEvalName = ''"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="f in evalNames" :key="f" @click="chooseEval(f)"
                        :class="{ 'list-group-item-info': selectedEvalName == f }"
                        role="button"
                      )
                        | {{f}}

                //// Eval tab - central column
                .d-flex.flex-column.scrollable-column.border.flex-grow-1(style="max-width: 20em")
                  .px-3.pt-4

                    h3.mt-3 Run config: {{selectedEvalName}}

                    .mt-4
                    button.btn.btn-success(@click="runEval" :disabled="isEvaluating")
                      span.spinner-border.spinner-border-sm(
                        v-if="isEvaluating"
                        role="status"
                        aria-hidden="true"
                      )
                      | {{ isEvaluating ? ' evaluating...' : 'evaluate' }}


                    h5.mt-4 Repeat
                    .form-group
                      input#repeat.form-control(
                        type="number"
                        v-model="testConfig.repeat"
                        placeholder="1"
                        min="1"
                      )

                    h5.mt-3 Service
                    .form-group
                      input#name.form-control(type="text" v-model="testConfig.service" placeholder="query")

                      h5.mt-3 Model
                    .form-group
                      input#name.form-control(type="text" v-model="testConfig.model" placeholder="query")

                    h5.mt-4 Evaluators
                    .form-group
                      div(v-for="evaluator in allEvaluators" :key="evaluator")
                        .form-check
                          input.form-check-input(
                            type="checkbox"
                            :id="'evaluator-' + evaluator"
                            :value="evaluator"
                            v-model="testConfig.evaluators"
                          )
                          label.form-check-label(:for="'evaluator-' + evaluator")
                            | {{ evaluator }}

                    hr

                    h3.mt-3 Results

                    .mt-4
                    template(v-if="evalResult")
                      .table-responsive(v-if="evalResult.length")
                        table.table.table-striped
                          thead
                            tr
                              th Metric
                              th Value
                          tbody
                            tr(v-for="(row, index) in evalResult" :key="index")
                              td {{ row.name }}
                              td
                                | {{ parseFloat(row.average).toFixed(1) }}
                                | ± {{ parseFloat(row.standardDeviation).toFixed(1) }}

                    .form-group(v-if="sampleModelResponse")
                      h5.mt-3 Sample Model Response
                      textarea.form-control(rows="20" v-model="sampleModelResponse" readonly)

                //// Eval tab - right column
                .d-flex.flex-column.scrollable-column.border-end.flex-grow-1
                  .px-3.pt-4

                    .d-flex.flex-row.align-items-end
                      h5.mt-3 System Prompt:
                      .ms-2.form-group
                        select.form-select(v-model="testConfig.systemPromptRef" @change="loadSystemPrompt")
                          option(value="" disabled)
                            | Select a system prompt
                          option(v-for="prompt in systemPrompts" :key="prompt" :value="prompt")
                            | {{ prompt }}

                    .form-group
                      textarea.form-control(
                        rows="7"
                        v-model="systemPrompt"
                        placeholder="Please summarize the skills of this candidate."
                        readonly
                      )

                    h5.mt-3 Query: {{testConfig.queryRef}}
                    .form-group
                      textarea#input.form-control(
                        rows="20"
                        v-model="testConfig.prompt"
                        placeholder="A humble query"
                      )

                    h5.mt-4 Expected
                    .form-group
                      textarea#expected.form-control(
                        rows="20"
                        v-model="testConfig.expectedAnswer"
                        placeholder="expected"
                      )

                    .pb-5
                    .pb-5

            /// Queries tab
            #queries-tab.tab-pane.fade.h-100
              .d-flex.flex-row.h-100

                //// Queries tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 300px;")
                  .px-3.pt-4

                    h3 Queries

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#create-query-modal"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="query in queries"
                        :key="query"
                        @click="chooseQuery(query)"
                        :class="{ 'list-group-item-info': selectedQueryName == query }"
                        role="button"
                      )
                        | {{query}}

                //// Queries tab - central column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedQueryName}}: prompt

                    textarea.form-control(rows="25" v-model="query.prompt")

                    button.btn.btn-success(
                      @click="saveSystemPrompt" :disabled="isSavingPrompt"
                    )
                      span.spinner-border.spinner-border-sm(Z
                        v-if="isSavingPrompt" role="status" aria-hidden="true"
                      )
                      | {{ isSavingPrompt ? ' saving...' : 'save' }}

                //// Queries tab - right column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedQueryName}}: answer

                    textarea.form-control(rows="25" v-model="query.expectedAnswer")

                    button.btn.btn-success(
                      @click="saveSystemPrompt" :disabled="isSavingPrompt"
                    )
                      span.spinner-border.spinner-border-sm(
                        v-if="isSavingPrompt" role="status" aria-hidden="true"
                      )
                      | {{ isSavingPrompt ? ' saving...' : 'save' }}

            /// System prompts tab
            #system-prompts-tab.tab-pane.fade.h-100
              .d-flex.flex-row.h-100

                //// System Prompts tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 300px;")
                  .px-3.pt-4

                    h3 System Prompts

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#create-system-prompt-modal"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="prompt in systemPrompts"
                        :key="prompt"
                        @click="chooseSystemPrompt(prompt)"
                        :class="{ 'list-group-item-info': selectedSystemPromptName == prompt }"
                        role="button"
                      )
                        | {{prompt}}

                //// System Prompts tab - right column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedSystemPromptName}}

                    textarea.form-control(rows="25" v-model="systemPrompt")

                    button.btn.btn-success(
                      @click="saveSystemPrompt" :disabled="isSavingPrompt"
                    )
                      span.spinner-border.spinner-border-sm(
                        v-if="isSavingPrompt" role="status" aria-hidden="true"
                      )
                      | {{ isSavingPrompt ? ' saving...' : 'save' }}

        //// Modals

        // Create Eval Modal
        .modal.fade(id="createEvalModal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New Eval
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label Eval Name
                  input.form-control(
                    type="text"
                    v-model="newEvalName"
                    placeholder="eval-name"
                    id="evalNameInput"
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(@click="createEval" :disabled="!newEvalName") Create

        // Create System Prompt Modal
        .modal.fade(id="create-system-prompt-modal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New System Prompt
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label System Prompt Name
                  input.form-control(
                    type="text"
                    v-model="newSystemPromptName"
                    placeholder="prompt-name"
                    id="systemPromptNameInput"
                    @keyup.entßßer="createSystemPrompt"
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(
                  @click="createSystemPrompt"
                  :disabled="!newSystemPromptName"
                ) Create
    `);

    function deepCamelCaseKeys(value) {
      if (_.isArray(value)) {
        return value.map(deepCamelCaseKeys);
      }
      if (_.isPlainObject(value)) {
        const camelKeyed = _.mapKeys(value, (v, k) => _.camelCase(k));
        return _.mapValues(camelKeyed, deepCamelCaseKeys);
      }
      return value;
    }

    function deepSnakeCaseKeys(value) {
      if (_.isArray(value)) {
        return value.map(deepSnakeCaseKeys);
      }
      if (_.isPlainObject(value)) {
        const snakeKeyed = _.mapKeys(value, (v, k) => _.snakeCase(k));
        return _.mapValues(snakeKeyed, deepSnakeCaseKeys);
      }
      return value;
    }

    async function getJson(url, field=null) {
      let result = await ky.get(url).json();
      result = deepCamelCaseKeys(result);
      if (field) {
        console.log("Loaded field:", url, field, _.cloneDeep(result[field]));
        return result[field];
      }
      console.log("Loaded result:", url, _.cloneDeep(result));
      return result;
    }

    async function postJsonContent(url, json) {
      let result = await ky.post(url, { json , timeout: 600000}).json();
      result = deepCamelCaseKeys(result);
      console.log("Loaded result.content:", url);
      return result.content;
    }

    const { createApp, ref, onMounted } = Vue;

    function setup() {
      // State
      const evalNames = ref([]);
      const allEvaluators = ref([]);
      const selectedEvalName = ref("");
      const newEvalName = ref("");
      const testConfig = ref({
        systemPromptRef: "",
        prompt: "",
        expectedAnswer: "",
        repeat: 1,
        model: "",
        evaluators: [],
      });
      const evalResult = ref({});
      const isEvaluating = ref(false);
      const sampleModelResponse = ref("");

      const systemPrompts = ref([]);
      const selectedSystemPromptName = ref("");
      const newSystemPromptName = ref("");
      const systemPrompt = ref("");

      const isSavingPrompt = ref(false);

      const queries = ref([]);
      const query = ref({prompt: "", expectedAnswer: ""});
      const selectedQueryName = ref("");
      const newQueryName = ref("");

      const notifications = ref([]);

      // Lifecycle hooks
      // Initialize toast when a new notification is added
      function initializeToast(toastEl) {
        const toast = new bootstrap.Toast(toastEl, { autohide: true });
        toast.show();

        // Auto-hide after timeout
        toastEl.addEventListener("hidden.bs.toast", () => {
          const id = parseInt(toastEl.getAttribute("data-toast-id"));
          removeNotification(id);
        });
      }

      onMounted(async () => {
        await loadEvalNames();
        await loadSystemPrompts();
        await loadQueries();
        allEvaluators.value = await getJson("/evaluators", "evaluators");
        await chooseEval(evalNames.value[0]);
      });

      // Methods
      async function loadEvalNames() {
        evalNames.value = await getJson("/evals", "values");
      }

      async function loadSystemPrompts() {
        systemPrompts.value = await getJson("/system-prompts", "values");
      }

      async function loadQueries() {
        queries.value = await getJson("/queries", "values");
      }

      async function chooseEval(evalName) {
        selectedEvalName.value = evalName;
        systemPrompt.value = "";
        await Promise.all([loadTestConfig(evalName), loadEvalResult(evalName)]);
      }

      async function loadTestConfig(evalName) {
        testConfig.value = await postJsonContent("/eval", { basename: evalName });
        console.log("Loaded test config:", _.cloneDeep(testConfig.value));
        query.value.prompt = testConfig.value.prompt;
        query.value.expectedAnswer = testConfig.value.expectedAnswer;
        if (testConfig.value.systemPromptRef) {
          await loadSystemPrompt();
        }
      }

      async function loadEvalResult(evalName) {
        evalResult.value = {};
        sampleModelResponse.value = "";
        const content = await postJsonContent("/result", { basename: evalName });
        if (content) {
          evalResult.value = content.evaluations || [];
          const responseTexts = content.texts || [];
          sampleModelResponse.value = responseTexts[0] || "";
        }
      }

      async function loadSystemPrompt() {
        if (testConfig.value.systemPromptRef) {
          systemPrompt.value = await postJsonContent("/system-prompt", { basename: testConfig.value.systemPromptRef });
          selectedSystemPromptName.value = testConfig.value.systemPromptRef;
          selectedQueryName.value = testConfig.value.queryRef;
        }
      }

      async function runEval() {
        if (!selectedEvalName.value) return;

        isEvaluating.value = true;
        evalResult.value = {};
        sampleModelResponse.value = "";
        showNotification("Starting evaluation...", "info");

        try {
          console.log("Running evaluation with config:", testConfig.value);
          await postJsonContent(`/evaluate`, {
            basename: selectedEvalName.value,
            config: deepSnakeCaseKeys(testConfig.value),
          });

          await loadEvalResult(selectedEvalName.value);
          showNotification("Evaluation completed successfully!", "success");
        } catch (error) {
          console.error("Failed to run evaluation:", error);
          showNotification(
            "Evaluation failed. Check console for details",
            "danger",
          );
        } finally {
          isEvaluating.value = false;
        }
      }

      async function createEval() {
        if (!newEvalName.value) return;

        try {
          await postJsonContent("/create-eval", {
            basename: newEvalName.value,
          });

          await loadEvalNames();
          await chooseEval(newEvalName.value);
          newEvalName.value = ""; // Clear the input field
          showNotification("Evaluation created successfully!");
        } catch (error) {
          console.error("Failed to create evaluation:", error);
          showNotification("Failed to create evaluation", "danger");
        }

        closeBootstrapModal("createEvalModal");
      }

      async function chooseSystemPrompt(promptName) {
        selectedSystemPromptName.value = promptName;
        systemPrompt.value = "";
        systemPrompt.value = await postJsonContent("/system-prompt", { basename: promptName });
      }

      async function chooseQuery(queryName) {
        selectedQueryName.value = queryName;
        query.value = "";
        query.value = await postJsonContent("/query", { basename: queryName });
      }

      function saveQuery() {}

      function createQuery() {}

      function showNotification(message, type = "success") {
        const id = Date.now();
        const bgClass =
          {
            success: "bg-success",
            danger: "bg-danger",
            info: "bg-info",
            warning: "bg-warning",
          }[type] || "bg-success";

        const notification = {
          id,
          message,
          type,
          bgClass,
          timeout: type === "info" ? 3000 : 5000, // 3 seconds for info, 5 for others
        };

        notifications.value.push(notification);

        // Initialize toast after Vue has updated the DOM
        Vue.nextTick(() => {
          const toastEl = document.querySelector(`[data-toast-id="${id}"]`);
          if (toastEl) {
            initializeToast(toastEl);
          }
        });
      }

      function removeNotification(id) {
        const index = notifications.value.findIndex((n) => n.id === id);
        if (index !== -1) {
          notifications.value.splice(index, 1);
        }
      }

      async function saveSystemPrompt() {
        if (!selectedSystemPromptName.value) return;

        isSavingPrompt.value = true;

        try {
          await ky.post("/save-system-prompt", {
            json: {
              basename: selectedSystemPromptName.value,
              content: systemPrompt.value,
            },
          });

          await loadSystemPrompts();
          showNotification("System prompt saved successfully!");
        } catch (error) {
          showNotification("Failed to save system prompt", "danger");
        } finally {
          isSavingPrompt.value = false;
        }
      }

      function closeBootstrapModal(modalId) {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById(modalId),
        );
        if (modal) modal.hide();
      }
      async function createSystemPrompt() {
        if (!newSystemPromptName.value) return;

        try {
          await ky.post("/create-system-prompt", {
            json: {
              basename: newSystemPromptName.value,
              content: "",
            },
          });

          await loadSystemPrompts();
          await chooseSystemPrompt(newSystemPromptName.value);
          newSystemPromptName.value = ""; // Clear the input field
          showNotification("System prompt created successfully!");
        } catch (error) {
          console.error("Failed to create system prompt:", error);
          showNotification("Failed to create system prompt", "danger");
        }

        closeBootstrapModal("create-system-prompt-modal");
      }

      // Expose methods and state to template
      return {
        // State
        evalNames,
        allEvaluators,
        selectedEvalName,
        newEvalName,
        testConfig,
        evalResult,
        isEvaluating,
        sampleModelResponse,
        systemPrompts,
        selectedSystemPromptName,
        newSystemPromptName,
        systemPrompt,
        isSavingPrompt,
        queries,
        selectedQueryName,
        newQueryName,
        query,
        notifications,

        // Methods
        chooseEval,
        createEval,
        runEval,
        loadSystemPrompt,
        chooseSystemPrompt,
        saveSystemPrompt,
        createSystemPrompt,
        chooseQuery,
        saveQuery,
        createQuery,
        closeBootstrapModal,
      };
    }

    // Initialize the app
    document.addEventListener("DOMContentLoaded", () => {
      const app = createApp({
        template,
        setup,
      });
      app.mount("#app");
    });
  </script>
</html>
