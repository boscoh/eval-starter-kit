<!doctype html>
<html>
  <head>
    <!-- avoid text rendering issues on various platforms -->
    <meta charset="utf-8" />

    <!-- prevent auto-zooming on mobile browsers -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Lodash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Pug template compiler -->
    <script src="https://pugjs.org/js/pug.js"></script>
    <script>
      window.pug = require("pug");

      function renderHtmlFromPug(str) {
        const lines = str.replace(/^\n/, "").split("\n");
        const minIndent = Math.min(
          ...lines
            .filter((l) => l.trim())
            .map((l) => l.match(/^\s*/)[0].length),
        );
        return pug.render(lines.map((l) => l.slice(minIndent)).join("\n"));
      }
    </script>

    <!-- Ky -->
    <script type="module">
      import ky from "https://unpkg.com/ky/distribution/index.js";

      window.ky = ky;
    </script>

    <!-- Custom styles -->
    <style>
      .scrollable-column {
        height: calc(100vh - 106px);
        overflow-y: auto;
      }
    </style>
  </head>

  <body class="overflow-hidden">
    <div id="app"></div>
  </body>

  <script>
    // language=pug
    const template = renderHtmlFromPug(`
    .container-fluid.h-100
      .row.h-100
        .col-12

          // Title
          .d-flex.justify-content-between.align-items-center.mt-3
            h3.mb-0 Eval Starter Kit

          // Tab navigation
          ul.nav.nav-tabs.mt-3
            li.nav-item
              a.nav-link.active(data-bs-toggle="tab" href="#evals-tab")
                | Evals
            li.nav-item
              a.nav-link(data-bs-toggle="tab" href="#system-prompts-tab")
                | System Prompts

          // Tab content
          .tab-content.h-100

            /// Eval tab
            #evals-tab.tab-pane.fade.show.active.h-100
              .d-flex.flex-row

                //// Eval tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 250px;")
                  .px-3.pt-4

                    h3 Evals
                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#createEvalModal"
                      @click="newEvalName = ''"
                    ) + Create Eval

                    ul.list-group
                      li.list-group-item(
                        v-for="f in evalNames" :key="f" @click="chooseEval(f)"
                        :class="{ 'list-group-item-info': selectedEvalName == f }"
                        role="button"
                      )
                        | {{f}}

                //// Eval tab - middle column
                .d-flex.flex-column.scrollable-column.border-end.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedEvalName}}

                    h5.mt-3 System Prompt
                    .form-group
                      select.form-select(v-model="testConfig.system_prompt_ref" @change="loadSystemPrompt")
                        option(value="" disabled)
                          | Select a system prompt
                        option(v-for="prompt in systemPrompts" :key="prompt" :value="prompt")
                          | {{ prompt }}
                    .form-group
                      textarea.form-control(
                        rows="20"
                        v-model="systemPrompt"
                        placeholder="Please summarize the skills of this candidate."
                        readonly
                      )

                    form(@submit.prevent="runEval")

                      h5.mt-3 Prompt
                      .form-group
                        textarea#input.form-control(
                          rows="20"
                          v-model="testConfig.prompt"
                          placeholder="A humble query"
                        )

                      h5.mt-4 Expected
                      .form-group
                        textarea#expected.form-control(
                          rows="20"
                          v-model="testConfig.expected_answer"
                          placeholder="expected"
                        )

                      h5.mt-4 Repeat
                      .form-group
                        input#repeat.form-control(
                          type="number"
                          v-model="testConfig.repeat"
                          placeholder="1"
                          min="1"
                        )

                      h5.mt-3 Model
                      .form-group
                        input#name.form-control(type="text" v-model="testConfig.model" placeholder="query")

                      h5.mt-4 Evaluators
                      .form-group
                        div(v-for="evaluator in allEvaluators" :key="evaluator")
                          .form-check
                            input.form-check-input(
                              type="checkbox"
                              :id="'evaluator-' + evaluator"
                              :value="evaluator"
                              v-model="testConfig.evaluators"
                            )
                            label.form-check-label(:for="'evaluator-' + evaluator")
                              | {{ evaluator }}

                    .pb-5
                    .pb-5

                //// Eval tab - right column
                .d-flex.flex-column.scrollable-column.border(style="flex: 0 0 500px;")
                  .px-3.pt-4

                    .mt-5
                    button.btn.btn-success(@click="runEval" :disabled="isEvaluating")
                      span.spinner-border.spinner-border-sm(
                        v-if="isEvaluating"
                        role="status"
                        aria-hidden="true"
                      )
                      | {{ isEvaluating ? ' Evaluating...' : 'Evaluate' }}

                    .mt-4
                    template(v-if="evalResult")
                      .table-responsive(v-if="evalResult.length")
                        table.table.table-striped
                          thead
                            tr
                              th Metric
                              th Value
                          tbody
                            tr(v-for="(row, index) in evalResult" :key="index")
                              td {{ row.name }}
                              td
                                | {{ parseFloat(row.average).toFixed(1) }}
                                | Â± {{ parseFloat(row.standard_deviation).toFixed(1) }}

                    .form-group(v-if="sampleModelResponse")
                      h5.mt-3 Sample Model Response
                      textarea.form-control(rows="20" v-model="sampleModelResponse" readonly)

            /// System prompts tab
            #system-prompts-tab.tab-pane.fade.h-100
              .d-flex.flex-row.h-100

                //// System Prompts tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 300px;")
                  .px-3.pt-4

                    h3 System Prompts

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#createSystemPromptModal"
                    ) + Create

                    ul.list-group
                      li.list-group-item(
                        v-for="prompt in systemPrompts" :key="prompt" @click="chooseSystemPrompt(prompt)"
                        :class="{ 'list-group-item-info': selectedSystemPromptName == prompt }"
                        role="button"
                      )
                        | {{prompt}}

                //// System Prompts tab - right column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedSystemPromptName}}

                    .form-group(v-if="systemPrompt")
                      textarea.form-control(rows="25" v-model="systemPrompt")

                    .form-group(v-if="systemPrompt")
                      button.btn.btn-success(@click="saveSystemPrompt" :disabled="isSavingPrompt")
                        span.spinner-border.spinner-border-sm(v-if="isSavingPrompt" role="status" aria-hidden="true")
                        | {{ isSavingPrompt ? ' Saving...' : 'Save System Prompt' }}

        //// Modals

        // Create Eval Modal
        .modal.fade(id="createEvalModal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New Eval
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label Eval Name
                  input.form-control(
                    type="text"
                    v-model="newEvalName"
                    placeholder="eval-name"
                    id="evalNameInput"
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(@click="createEval" :disabled="!newEvalName") Create

        // Create System Prompt Modal
        .modal.fade(id="createSystemPromptModal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New System Prompt
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label System Prompt Name
                  input.form-control(
                    type="text"
                    v-model="newSystemPromptName"
                    placeholder="prompt-name"
                    id="systemPromptNameInput"
                    @keyup.enter="createSystemPrompt"
                    data-bs-dismiss="modal"
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(
                  @click="createSystemPrompt"
                  :disabled="!newSystemPromptName"
                  data-bs-dismiss="modal"
                ) Create

  `);

    const { createApp, ref, onMounted } = Vue;

    function setup() {
      // State
      const evalNames = ref([]);
      const allEvaluators = ref([]);
      const selectedEvalName = ref("");
      const newEvalName = ref("");
      const testConfig = ref({
        system_prompt_ref: "",
        prompt: "",
        expected_answer: "",
        repeat: 1,
        model: "",
        evaluators: [],
      });
      const evalResult = ref({});
      const isEvaluating = ref(false);
      const sampleModelResponse = ref("");
      const systemPrompts = ref([]);
      const selectedSystemPromptName = ref("");
      const newSystemPromptName = ref("");
      const systemPrompt = ref("");
      const isSavingPrompt = ref(false);

      // Lifecycle hooks
      onMounted(async () => {
        await loadEvalNames();
        await loadSystemPrompts();
        const response = await ky.get("/evaluators").json();
        allEvaluators.value = response.evaluators;

        if (evalNames.value.length > 0) {
          await chooseEval(evalNames.value[0]);
        }
      });

      // Methods
      async function loadEvalNames() {
        try {
          const result = await ky.get("/evals").json();
          evalNames.value = result.files;
          console.log("Loaded eval names:", evalNames.value);
        } catch (error) {
          console.error("Failed to load eval names:", error);
        }
      }

      async function loadSystemPrompts() {
        try {
          const response = await ky.get("/system-prompts").json();
          systemPrompts.value = response.system_prompts;
          console.log("Loaded system prompts:", systemPrompts.value);
        } catch (error) {
          console.error("Failed to load system prompts:", error);
        }
      }

      async function chooseEval(evalName) {
        selectedEvalName.value = evalName;
        await Promise.all([loadTestConfig(evalName), loadEvalResult(evalName)]);
      }

      async function loadTestConfig(evalName) {
        try {
          const response = await ky
            .post("/eval", { json: { basename: evalName } })
            .json();
          testConfig.value = response.content;

          if (testConfig.value.system_prompt_ref) {
            await loadSystemPrompt();
          }
        } catch (error) {
          console.error(`Failed to load test config for ${evalName}:`, error);
        }
      }

      async function loadEvalResult(evalName) {
        evalResult.value = {};
        sampleModelResponse.value = "";

        try {
          const response = await ky
            .post("/summary", { json: { basename: evalName } })
            .json();
          console.log("Loaded eval result:", response);

          if (response.content) {
            evalResult.value = response.content.evaluations || [];
            const responseTexts = response.content.texts || [];
            sampleModelResponse.value = responseTexts[0] || "";
          }
        } catch (error) {
          console.log(`No summary found for ${evalName} - starting fresh`);
        }
      }

      async function loadSystemPrompt() {
        if (testConfig.value.system_prompt_ref) {
          try {
            const response = await ky
              .post("/system-prompt", {
                json: { basename: testConfig.value.system_prompt_ref },
              })
              .json();
            systemPrompt.value = response.content;
            selectedSystemPromptName.value = testConfig.value.system_prompt_ref;
          } catch (error) {
            console.error("Failed to load system prompt:", error);
          }
        }
      }

      async function runEval() {
        if (!selectedEvalName.value) return;

        isEvaluating.value = true;
        evalResult.value = {};
        sampleModelResponse.value = "";

        try {
          console.log("Running evaluation with config:", testConfig.value);
          await ky.post(`/evaluate`, {
            json: {
              basename: selectedEvalName.value,
              testConfig: testConfig.value,
            },
            timeout: 600000, // 10 minutes
          });

          await loadEvalResult(selectedEvalName.value);
        } catch (error) {
          console.error("Evaluation failed:", error);
          alert("Evaluation failed. Check console for details.");
        } finally {
          isEvaluating.value = false;
        }
      }

      async function createEval() {
        if (!newEvalName.value) return;

        try {
          await ky.post("/create-eval", {
            json: { basename: newEvalName.value },
          });

          await loadEvalNames();
          await chooseEval(newEvalName.value);

          const modal = bootstrap.Modal.getInstance(
            document.getElementById("createEvalModal"),
          );
          modal.hide();
        } catch (error) {
          console.error("Failed to create eval:", error);
          alert("Failed to create eval. Check console for details.");
        }
      }

      function chooseSystemPrompt(promptName) {
        selectedSystemPromptName.value = promptName;
        systemPrompt.value = "";
        ky.post("/system-prompt", { json: { basename: promptName } })
          .then((response) => response.json())
          .then((data) => {
            systemPrompt.value = data.content;
          });
      }

      async function saveSystemPrompt() {
        if (!selectedSystemPromptName.value) return;

        isSavingPrompt.value = true;

        try {
          await ky.post("/save-system-prompt", {
            json: {
              basename: selectedSystemPromptName.value,
              content: systemPrompt.value,
            },
          });

          await loadSystemPrompts();
          alert("System prompt saved successfully!");
        } catch (error) {
          console.error("Failed to save system prompt:", error);
          alert("Failed to save system prompt. Check console for details.");
        } finally {
          isSavingPrompt.value = false;
        }
      }

      async function createSystemPrompt() {
        if (!newSystemPromptName.value) return;

        try {
          await ky.post("/create-system-prompt", {
            json: {
              basename: newSystemPromptName.value,
              content: "",
            },
          });

          await loadSystemPrompts();
          await chooseSystemPrompt(newSystemPromptName.value);
          newSystemPromptName.value = ""; // Clear the input field
        } catch (error) {
          console.error("Failed to create system prompt:", error);
          alert("Failed to create system prompt. Check console for details.");
        }
      }

      // Expose variables and methods to template
      return {
        // State
        evalNames,
        allEvaluators,
        selectedEvalName,
        newEvalName,
        testConfig,
        evalResult,
        isEvaluating,
        sampleModelResponse,
        systemPrompts,
        selectedSystemPromptName,
        newSystemPromptName,
        systemPrompt,
        isSavingPrompt,

        // Methods
        chooseEval,
        loadSystemPrompt,
        runEval,
        createEval,
        chooseSystemPrompt,
        saveSystemPrompt,
        createSystemPrompt,
      };
    }

    // Initialize the app
    document.addEventListener("DOMContentLoaded", () => {
      const app = createApp({
        template,
        setup,
      });
      app.mount("#app");
    });
  </script>
</html>
