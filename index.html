<!doctype html>
<html>
  <head>
    <!-- avoid text rendering issues on various platforms -->
    <meta charset="utf-8" />

    <!-- prevent auto-zooming on mobile browsers -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Lodash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Pug HTML template compiler -->
    <script src="https://pugjs.org/js/pug.js"></script>
    <script>
      window.pug = require("pug");

      function renderHtmlFromPug(str) {
        const lines = str.replace(/^\n/, "").split("\n");
        const minIndent = Math.min(
          ...lines
            .filter((l) => l.trim())
            .map((l) => l.match(/^\s*/)[0].length),
        );
        return pug.render(lines.map((l) => l.slice(minIndent)).join("\n"));
      }
    </script>

    <!-- Ky -->
    <script type="module">
      import ky from "https://unpkg.com/ky/distribution/index.js";

      window.ky = ky;
    </script>

    <!-- Custom styles -->
    <style>
      body {
        overflow-y: hidden;
      }
      .scrollable-column {
        height: calc(100vh - 182px);
        overflow-y: auto;
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
      }
    </style>
  </head>

  <body>
    <div id="app"></div>
  </body>

  <script>
    // language=pug
    const template = renderHtmlFromPug(`
    .container-fluid.h-100

      .toast-container
        .toast.align-items-center.text-white.border-0(
          v-for="(notification, index) in notifications"
          :key="notification.id"
          :data-toast-id="notification.id"
          :class="[notification.bgClass]"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
          data-bs-autohide="true"
          :data-bs-delay="notification.timeout"
        )
          .d-flex
            .toast-body {{ notification.message }}
            button.btn-close.btn-close-white.me-2.m-auto(
              type="button"
              data-bs-dismiss="toast"
              aria-label="Close"
            )

      .row.h-100
        .col-12

          // Title
          .d-flex.justify-content-between.align-items-center.mt-3
            .display-2.mx-3.my-3 Eval Starter Kit

          // Tab navigation
          ul.nav.nav-tabs.mt-3
            li.nav-item
              a.nav-link.active(data-bs-toggle="tab" href="#runs-tab")
                | Runs
            li.nav-item
              a.nav-link(data-bs-toggle="tab" href="#queries-tab")
                | Queries
            li.nav-item
              a.nav-link(data-bs-toggle="tab" href="#prompts-tab")
                | Prompts

          // Tab content
          .tab-content.h-100

            /// Run tab
            #runs-tab.tab-pane.fade.show.active.h-100
              .d-flex.flex-row

                //// Run tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 250px;")
                  .px-3.pt-4

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#create-run-modal"
                      @click="newRunName = ''"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="f in runNames" :key="f" @click="chooseRun(f)"
                        :class="{ 'list-group-item-info': selectedRunName == f }"
                        role="button"
                      )
                        | {{f}}

                  //// Run tab - central column
                .d-flex.flex-column.scrollable-column.border.flex-grow-1(style="max-width: 20em")
                  .px-3.pt-4

                    h3.mt-3 Run config: {{selectedRunName}}

                    .mt-4
                    button.btn.btn-success(@click="runEvaluation" :disabled="isEvaluating")
                      span.spinner-border.spinner-border-sm(
                        v-if="isEvaluating"
                        role="status"
                        aria-hidden="true"
                      )
                      | {{ isEvaluating ? ' evaluating...' : 'evaluate' }}


                    h5.mt-4 Repeat
                    .form-group
                      input#repeat.form-control(
                        type="number"
                        v-model="runConfig.repeat"
                        placeholder="1"
                        min="1"
                      )

                    h5.mt-3 Service
                    .form-group
                      select.form-select(v-model="runConfig.service")
                        option(value="" disabled)
                          | Select a service
                        option(v-for="(models, serviceName) in defaults.models" :key="serviceName" :value="serviceName")
                          | {{ serviceName }}

                      h5.mt-3 Model
                    .form-group
                      select.form-select(v-model="runConfig.model")
                        option(value="" disabled)
                          | Select a model
                        option(v-for="m in filteredModels" :key="m" :value="m")
                          | {{ m }}

                    h5.mt-4 Evaluators
                    .form-group
                      div(v-for="evaluator in defaults.evaluators" :key="evaluator")
                        .form-check
                          input.form-check-input(
                            type="checkbox"
                            :id="'evaluator-' + evaluator"
                            :value="evaluator"
                            v-model="runConfig.evaluators"
                          )
                          label.form-check-label(:for="'evaluator-' + evaluator")
                            | {{ evaluator }}

                    hr

                    h3.mt-3 Results

                    .mt-4
                    template(v-if="runResult")
                      .table-responsive(v-if="runResult.length")
                        table.table.table-striped
                          thead
                            tr
                              th Metric
                              th Value
                          tbody
                            tr(v-for="(row, index) in runResult" :key="index")
                              td {{ row.name }}
                              td
                                | {{ parseFloat(row.average).toFixed(1) }}
                                | Â± {{ parseFloat(row.standardDeviation).toFixed(1) }}

                    .form-group(v-if="sampleOutput")
                      h5.mt-3 Sample Model Response
                      textarea.form-control(rows="8" v-model="sampleOutput" readonly)

                //// Run tab - right column
                .d-flex.flex-column.scrollable-column.border-end.flex-grow-1
                  .px-3.pt-4

                    .d-flex.flex-row.align-items-end
                      h5.mt-3 Prompt:
                      .ms-2.form-group
                        select.form-select(v-model="runConfig.promptRef" @change="e => choosePromptOfRun(e.target.value)")
                          option(value="" disabled)
                            | Select a prompt
                          option(v-for="promptName in promptRefs" :key="promptName" :value="promptName")
                            | {{ promptName }}

                    .form-group
                      textarea.form-control(
                        rows="8"
                        v-model="runConfig.prompt"
                        placeholder="Please summarize the skills of this candidate."
                        readonly
                      )

                    .d-flex.flex-row.align-items-end
                      h5.mt-4 Query:
                      .ms-2.form-group
                      select.form-select(v-model="runConfig.queryRef" @change="e => chooseQueryOfRun(e.target.value)")
                        option(value="" disabled)
                          | Select a query
                        option(v-for="queryName in queryRefs" :key="queryName" :value="queryName")
                          | {{ queryName }}

                    h6.mt-3 Input:
                    .form-group
                      textarea#input.form-control(
                        rows="8"
                        v-model="runConfig.input"
                        placeholder="A humble query"
                        readonly
                      )

                    h6.mt-4 Output:
                    .form-group
                      textarea#expected.form-control(
                        rows="8"
                        v-model="runConfig.output"
                        placeholder="expected"
                        readonly
                      )

                    .pb-5
                    .pb-5

            /// Queries tab
            #queries-tab.tab-pane.fade.h-100
              .d-flex.flex-row.h-100

                //// Queries tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 300px;")
                  .px-3.pt-4

                    h3 Queries

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#create-query-modal"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="query in queryRefs"
                        :key="query"
                        @click="chooseSelectedQuery(query)"
                        :class="{ 'list-group-item-info': selectedQueryRef == query }"
                        role="button"
                      )
                        | {{query}}

                //// Queries tab - central column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 query[{{selectedQueryRef}}] - input

                    textarea.form-control(rows="25" v-model="selectedQuery.input")

                    .mt-3
                    button.btn.btn-success(
                      @click="saveQuery" :disabled="isSavingPrompt"
                    )
                      span.spinner-border.spinner-border-sm(Z
                      v-if="isSavingPrompt" role="status" aria-hidden="true"
                      )
                      | {{ isSavingPrompt ? ' saving...' : 'save' }}

                //// Queries tab - right column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 query[{{selectedQueryRef}}] - output

                    textarea.form-control(rows="25" v-model="selectedQuery.output")

            /// Prompts tab
            #prompts-tab.tab-pane.fade.h-100
              .d-flex.flex-row.h-100

                //// Prompts tab - left column
                .d-flex.flex-column.scrollable-column.border-end(style="flex: 0 0 300px;")
                  .px-3.pt-4

                    h3 Prompts

                    button.btn.btn-success(
                      data-bs-toggle="modal"
                      data-bs-target="#create-prompt-modal"
                    ) + new

                    ul.list-group
                      li.list-group-item(
                        v-for="promptName in promptRefs"
                        :key="promptName"
                        @click="chooseSelectedPrompt(promptName)"
                        :class="{ 'list-group-item-info': selectedPromptRef == promptName }"
                        role="button"
                      )
                        | {{promptName}}

                //// Prompts tab - right column
                .d-flex.flex-column.scrollable-column.flex-grow-1
                  .px-3.pt-4

                    h3.mt-5 {{selectedPromptRef}}

                    textarea.form-control(rows="25" v-model="selectedPrompt")

                    .mt-3
                    button.btn.btn-success(
                      @click="savePrompt" :disabled="isSavingPrompt"
                    )
                      span.spinner-border.spinner-border-sm(
                        v-if="isSavingPrompt" role="status" aria-hidden="true"
                      )
                      | {{ isSavingPrompt ? ' saving...' : 'save' }}

        // Modals

        // Create Eval Modal
        .modal.fade(id="create-run-modal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New Eval
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label Eval Name
                  input.form-control(
                    type="text"
                    v-model="newRunName"
                    placeholder="eval-name"
                    @keyup.enter="createRun"
                    autofocus
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(@click="createRun" :disabled="!newRunName") Create

        // Create Query Modal
        .modal.fade(id="create-query-modal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New Query
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label Query Name
                  input.form-control(
                    type="text"
                    v-model="newQueryRef"
                    placeholder="query-name"
                    @keyup.enter="createQuery"
                    autofocus
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(@click="createQuery" :disabled="!newQueryRef") Create

        // Create Prompt Modal
        .modal.fade(id="create-prompt-modal" tabindex="-1")
          .modal-dialog
            .modal-content
              .modal-header
                h5.modal-title Create New System Prompt
                button.btn-close(data-bs-dismiss="modal" aria-label="Close")
              .modal-body
                .form-group.mb-3
                  label.form-label System Prompt Name
                  input.form-control(
                    type="text"
                    v-model="newPromptRef"
                    placeholder="prompt-name"
                    @keyup.enter="createPrompt"
                    autofocus
                  )
              .modal-footer
                button.btn.btn-secondary(data-bs-dismiss="modal") Cancel
                button.btn.btn-primary(
                  @click="createPrompt"
                  :disabled="!newPromptRef"
                ) Create
    `);

    function deepCamelCaseKeys(value) {
      if (_.isArray(value)) {
        return value.map(deepCamelCaseKeys);
      }
      if (_.isPlainObject(value)) {
        const camelKeyed = _.mapKeys(value, (v, k) => _.camelCase(k));
        return _.mapValues(camelKeyed, deepCamelCaseKeys);
      }
      return value;
    }

    function deepSnakeCaseKeys(value) {
      if (_.isArray(value)) {
        return value.map(deepSnakeCaseKeys);
      }
      if (_.isPlainObject(value)) {
        const snakeKeyed = _.mapKeys(value, (v, k) => _.snakeCase(k));
        return _.mapValues(snakeKeyed, deepSnakeCaseKeys);
      }
      return value;
    }

    async function getJson(url) {
      let result = await ky.get(url).json();
      result = deepCamelCaseKeys(result);
      const content = result.content;
      console.log(`getJson ${url}`, _.cloneDeep(content));
      return content;
    }

    async function fetchObject(table, basename) {
      let result = await ky
        .post(`/fetch`, {
          json: {
            table,
            basename,
          },
        })
        .json();
      result = deepCamelCaseKeys(result);
      const content = result.content;
      console.log(`fetchObject`, _.cloneDeep(content));
      return content;
    }

    async function saveObject(table, basename, content) {
      let result = await ky
        .post(`/save`, {
          json: {
            table,
            basename,
            content,
          },
        })
        .json();
      result = deepCamelCaseKeys(result);
      const message = result.message;
      console.log(`saveObject`, _.cloneDeep(message));
      return message;
    }

    const { createApp, ref, onMounted, computed, watch } = Vue;

    function setup() {
      // State
      const defaults = ref({});

      const runNames = ref([]);
      const runConfig = ref({});
      const runResult = ref({});
      const selectedRunName = ref("");
      const newRunName = ref("");
      const isEvaluating = ref(false);
      const sampleOutput = ref("");

      const promptRefs = ref([]);
      const selectedPromptRef = ref("");
      const selectedPrompt = ref("");
      const newPromptRef = ref("");
      const isSavingPrompt = ref(false);

      const queryRefs = ref([]);
      const selectedQueryRef = ref("");
      const selectedQuery = ref({ input: "", output: "" });
      const newQueryRef = ref("");
      const isSavingQuery = ref(false);

      const notifications = ref([]);

      // Derived values
      const filteredModels = computed(() => {
        const svc = _.get(runConfig, 'value.service');
        const modelsMap = _.get(defaults, 'value.models', {}) || {};
        return svc && modelsMap[svc] ? modelsMap[svc] : [];
      });

      // Keep model consistent with selected service
      watch(
        () => _.get(runConfig, 'value.service'),
        () => {
          const current = _.get(runConfig, 'value.model');
          if (!filteredModels.value.includes(current)) {
            runConfig.value.model = "";
          }
        },
      );

      // Lifecycle hooks
      // Initialize toast when a new notification is added
      function initializeToast(toastEl) {
        const toast = new bootstrap.Toast(toastEl, { autohide: true });
        toast.show();

        // Auto-hide after timeout
        toastEl.addEventListener("hidden.bs.toast", () => {
          const id = parseInt(toastEl.getAttribute("data-toast-id"));
          removeNotification(id);
        });
      }

      onMounted(async () => {
        await loadRunNames();
        await loadPromptRefs();
        await loadQueryRefs();
        defaults.value = await getJson("/defaults");
        await chooseRun(runNames.value[0]);
      });

      // Methods
      async function loadRunNames() {
        runNames.value = await getJson("/list/run");
      }

      async function loadPromptRefs() {
        promptRefs.value = await getJson("/list/prompt");
      }

      async function loadQueryRefs() {
        queryRefs.value = await getJson("/list/query");
      }

      async function chooseRun(runName) {
        selectedRunName.value = runName;
        selectedPrompt.value = "";
        await loadRunConfig(runName);
        await loadRunResult(runName);
      }

      async function loadRunConfig(runName) {
        runConfig.value = await fetchObject("run", runName);
        await choosePromptOfRun(runConfig.value.promptRef);
        if (runConfig.value.queryRef) {
          await chooseQueryOfRun(runConfig.value.queryRef);
        }
      }

      async function choosePromptOfRun(promptRef) {
        if (!promptRef) {
          runConfig.value.promptRef = "";
          runConfig.value.prompt = "";
        } else {
          runConfig.value.promptRef = promptRef;
          runConfig.value.prompt = await fetchObject(
            "prompt",
            runConfig.value.promptRef,
          );
          await chooseSelectedPrompt(promptRef);
        }
      }

      async function chooseQueryOfRun(queryRef) {
        if (!queryRef) {
          runConfig.value.queryRef = "";
          runConfig.value.input = "";
          runConfig.value.output = "";
        } else {
          runConfig.value.queryRef = queryRef;
          const content = await fetchObject("query", runConfig.value.queryRef);
          runConfig.value.input = _.get(content, "input");
          runConfig.value.output = _.get(content, "output");
          await chooseSelectedQuery(queryRef);
        }
      }

      async function loadRunResult(runName) {
        runResult.value = {};
        sampleOutput.value = "";
        try {
          const content = await fetchObject("result", runName);
          runResult.value = content.evaluations || [];
          const responseTexts = content.texts || [];
          sampleOutput.value = responseTexts[0] || "";
        } catch (error) {
          console.error("Failed to load run result:", error);
        }
      }

      async function runEvaluation() {
        if (!selectedRunName.value) return;

        isEvaluating.value = true;
        runResult.value = {};
        sampleOutput.value = "";
        showNotification("Starting evaluation...", "info");

        try {
          console.log("Running evaluation with config:", runConfig.value);
          await ky.post(`/evaluate`, {
            json: {
              basename: selectedRunName.value,
              content: deepSnakeCaseKeys(runConfig.value),
            },
            timeout: 600000,
          });
          await loadRunResult(selectedRunName.value);
          showNotification("Evaluation completed successfully!", "success");
        } catch (error) {
          console.error("Failed to run evaluation:", error);
          showNotification(
            "Evaluation failed. Check console for details",
            "danger",
          );
        } finally {
          isEvaluating.value = false;
        }
      }

      async function createRun() {
        if (!newRunName.value) return;

        try {
          await saveObject("run", newRunName.value, defaults.value.runConfig);
          await loadRunNames();
          await chooseRun(newRunName.value);
          newRunName.value = ""; // Clear the input field
          showNotification("Evaluation created successfully!");
        } catch (error) {
          console.error("Failed to create evaluation:", error);
          showNotification("Failed to create evaluation", "danger");
        }

        closeBootstrapModal("create-run-modal");
      }

      async function createPrompt() {
        if (!newPromptRef.value) return;

        try {
          await saveObject(
            "prompt",
            newPromptRef.value,
            "A sample prompt to deal with input",
          );
          await loadPromptRefs();
          await chooseSelectedPrompt(newPromptRef.value);
          newPromptRef.value = ""; // Clear the input field
          showNotification("Prompt created successfully!");
        } catch (error) {
          console.error("Failed to create prompt:", error);
          showNotification("Failed to create prompt", "danger");
        }

        closeBootstrapModal("create-prompt-modal");
      }

      async function createQuery() {
        if (!newQueryRef.value) return;
        try {
          await saveObject("query", newQueryRef.value, {
            input: "Sample input",
            output: "Expected output",
          });
          await loadQueryRefs();
          await chooseSelectedQuery(newQueryRef.value);
          newQueryRef.value = ""; // Clear the input field
          showNotification("Query created successfully!");
        } catch (error) {
          console.error("Failed to create query:", error);
          showNotification("Failed to create query", "danger");
        }

        closeBootstrapModal("create-query-modal");
      }

      async function chooseSelectedPrompt(promptName) {
        selectedPromptRef.value = promptName;
        selectedPrompt.value = "";
        selectedPrompt.value = await fetchObject("prompt", promptName);
      }

      async function chooseSelectedQuery(queryName) {
        selectedQueryRef.value = queryName;
        selectedQuery.value = "";
        selectedQuery.value = await fetchObject("query", queryName);
      }

      async function saveQuery() {
        if (!selectedQueryRef.value) return;

        isSavingQuery.value = true;

        try {
          await saveObject(
            "query",
            selectedQueryRef.value,
            selectedQuery.value,
          );
          await loadQueryRefs();
          showNotification("Query saved successfully!");
        } catch (error) {
          console.error("Failed to save query:", error);
          showNotification("Failed to save query", "danger");
        } finally {
          isSavingQuery.value = false;
        }
      }

      async function savePrompt() {
        if (!selectedPromptRef.value) return;

        isSavingPrompt.value = true;

        try {
          await saveObject(
            "prompt",
            selectedPromptRef.value,
            selectedPrompt.value,
          );
          await loadPromptRefs();
          showNotification("System prompt saved successfully!");
        } catch (error) {
          showNotification("Failed to save system prompt", "danger");
        } finally {
          isSavingPrompt.value = false;
        }
      }

      function closeBootstrapModal(modalId) {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById(modalId),
        );
        if (modal) modal.hide();
      }

      function showNotification(message, type = "success") {
        const id = Date.now();
        const bgClass =
          {
            success: "bg-success",
            danger: "bg-danger",
            info: "bg-info",
            warning: "bg-warning",
          }[type] || "bg-success";

        const notification = {
          id,
          message,
          type,
          bgClass,
          timeout: type === "info" ? 3000 : 5000, // 3 seconds for info, 5 for others
        };

        notifications.value.push(notification);

        // Initialize toast after Vue has updated the DOM
        Vue.nextTick(() => {
          const toastEl = document.querySelector(`[data-toast-id="${id}"]`);
          if (toastEl) {
            initializeToast(toastEl);
          }
        });
      }

      function removeNotification(id) {
        const index = notifications.value.findIndex((n) => n.id === id);
        if (index !== -1) {
          notifications.value.splice(index, 1);
        }
      }

      // Expose methods and state to template
      return {
        // State
        runNames,
        defaults,
        selectedRunName,
        newRunName,
        runConfig,
        runResult,
        isEvaluating,
        sampleOutput,
        promptRefs,
        selectedPromptRef,
        newPromptRef,
        selectedPrompt,
        isSavingPrompt,
        queryRefs,
        selectedQueryRef,
        newQueryRef,
        selectedQuery,
        notifications,
        filteredModels,

        // Methods
        chooseRun,
        createRun,
        runEvaluation,
        chooseQueryOfRun,
        choosePromptOfRun,
        chooseSelectedPrompt,
        savePrompt,
        createPrompt,
        chooseSelectedQuery,
        saveQuery,
        createQuery,
        closeBootstrapModal,
      };
    }

    // Initialize the app
    document.addEventListener("DOMContentLoaded", () => {
      const app = createApp({
        template,
        setup,
      });
      app.mount("#app");
    });
  </script>
</html>
